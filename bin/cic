#!/usr/bin/env bash

CURRENT_PATH="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
# shellcheck source=bin/support/sh/functions/cic_docker.sh
source "${CURRENT_PATH}/support/sh/functions/cic_docker.sh"
# shellcheck source=bin/support/sh/functions/cic.sh
source "${CURRENT_PATH}/support/sh/functions/cic.sh"

# shellcheck disable=SC2016
rbenv_init='eval "$(rbenv init -)"'
cic_environment="CIC_COURSEWARE_VERSION=$(cic_image_version) CIC_COURSEWARE_IMAGE=$(cic_image_repository)"
cic_command="${rbenv_init} && ${cic_environment} /cic/bin/support/ruby/bin/cic"

options=""
subcommand=$1

if [ "${subcommand}" == "track" ]; then
    command="${cic_command} $*"
else

    if [ "${subcommand}" == "connect" ]; then
        options='-it'
    fi

    image=$2
    switch=$3
    container_command=$4

    command="${cic_command} ${subcommand} ${image} ${switch}"

    if [ "${container_command}" != "" ]; then
        command="${command} '${container_command}'"
    fi
fi

docker run ${options} \
    -v /sys/fs/cgroup:/sys/fs/cgroup:ro \
    -v /var/run/docker.sock:/var/run/docker.sock \
    -v "$(tracks_path)":/cic/tracks \
    -v "$(exercises_path)":/cic/exercises \
    -v "${HOME}/.netrc":/root/.netrc \
    "$(cic_image)" \
    /bin/bash -c "${command}"