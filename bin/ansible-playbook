#!/usr/bin/env bash
CURRENT_PATH="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

# shellcheck source=bin/support/sh/functions/output.sh
source "${CURRENT_PATH}/support/sh/functions/output.sh"

course_image='lvlup/ci_course'
current_dir=$(pwd)

if docker run --privileged \
    --network cic \
    -v "${current_dir}:/mnt/workdir" \
    -v /sys/fs/cgroup:/sys/fs/cgroup:ro \
    -w /mnt/workdir \
    ${course_image} ansible-playbook "$@"
then
    container_id=$(docker ps -ql)

    tag="${course_image}:${container_id}"
    docker commit "${container_id}" "${tag}" > /dev/null

    say "$(ok "FINISHED - start container with: cic start ${tag}")"
else
    exit 1
fi
