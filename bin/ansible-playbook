#!/usr/bin/env ruby

require_relative 'support/ruby/lib/commandline'

include Commandline::Output

course_image = "lvlup/ci_course"
current_dir = Dir.pwd

command = "docker run --privileged --network bridge -v #{current_dir}:/mnt/workdir  -v /sys/fs/cgroup:/sys/fs/cgroup:ro -w /mnt/workdir #{course_image} ansible-playbook #{ARGV.join(" ")}"

result = system(command)
container_id = `docker ps -ql`.chomp.strip

tag = "#{course_image}:#{container_id}"
system "docker commit #{container_id} #{tag} > /dev/null"

message = if result
            ok "FINISHED - connect with: cic start #{tag}"
          else
            error "FAILED - connect with: cic start #{tag}"
          end
say message
