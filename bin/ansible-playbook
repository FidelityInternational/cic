#!/usr/bin/env ruby

require_relative 'lib/commandline'

include Commandline

current_dir = Dir.pwd
command = "docker run --privileged --network bridge -v #{current_dir}:/mnt/workdir  -v /sys/fs/cgroup:/sys/fs/cgroup:ro -w /mnt/workdir ci_course:blank_box ansible-playbook #{ARGV.join(" ")}"

result = system(command)
container_id = `docker ps -ql`.chomp.strip

system("docker container rename #{container_id} ci_course-#{container_id}")

tag = "ci_course:#{container_id}"
system "docker commit #{container_id} #{tag} > /dev/null"
system "docker commit #{container_id} ci_course:latest  > /dev/null"

message = if result
            ok "FINISHED - connect with: cic start #{tag}"
          else
            error "FAILED - connect with: cic start #{tag}"
          end
say message
